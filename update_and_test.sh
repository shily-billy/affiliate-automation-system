#!/bin/bash

# ==============================================================================
# Affiliate Automation System - Update & Test Script
# ==============================================================================
# Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª:
# 1. Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª Ø±Ùˆ Ø§Ø² GitHub Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡
# 2. Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ù†ØµØ¨ Ù…ÛŒâ€ŒÚ©Ù†Ù‡
# 3. Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ùˆ ØªØ³Øª Ù…ÛŒâ€ŒÚ©Ù†Ù‡
# ==============================================================================

set -e  # Ø®Ø±ÙˆØ¬ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§

# Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ==============================================================================
# ØªÙˆØ§Ø¨Ø¹
# ==============================================================================

print_step() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')]${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# ==============================================================================
# Ø´Ø±ÙˆØ¹
# ==============================================================================

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸš€ Affiliate Automation System - Update & Test"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ==============================================================================
# STEP 1: Ú†Ú© Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ ØªÙˆÛŒ Ù¾ÙˆØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ù‡Ø³ØªÛŒÙ…
# ==============================================================================

print_step "Ú†Ú© Ú©Ø±Ø¯Ù† Ù¾ÙˆØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡..."

if [ ! -f "README.md" ] || [ ! -f "requirements.txt" ]; then
    print_error "Ø§ÛŒÙ† Ù¾ÙˆØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ù†ÛŒØ³Øª!"
    echo "Ù„Ø·ÙØ§Ù‹ ØªÙˆÛŒ Ù¾ÙˆØ´Ù‡ affiliate-automation-system Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯:"
    echo "  cd ~/projects/affiliate-automation-system"
    echo "  ./update_and_test.sh"
    exit 1
fi

print_success "Ù¾ÙˆØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ OK"

# ==============================================================================
# STEP 2: Pull Ú©Ø±Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª
# ==============================================================================

print_step "Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø² GitHub..."

if git pull origin main; then
    print_success "Ø¢Ù¾Ø¯ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"
else
    print_error "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØºÛŒÛŒØ±Ø§Øª!"
    print_warning "Ù…Ù…Ú©Ù†Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù‚Ø·Ø¹ Ø¨Ø§Ø´Ù‡ ÛŒØ§ ØªØºÛŒÛŒØ±Ø§Øª Ù„ÙˆÚ©Ø§Ù„ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯"
    echo "Ø¨Ø±Ø§ÛŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† ØªØºÛŒÛŒØ±Ø§Øª Ù„ÙˆÚ©Ø§Ù„:"
    echo "  git reset --hard origin/main"
    exit 1
fi

# ==============================================================================
# STEP 3: Ù†ØµØ¨/Ø¢Ù¾Ø¯ÛŒØª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§
# ==============================================================================

print_step "Ù†ØµØ¨/Ø¢Ù¾Ø¯ÛŒØª Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ÛŒ Python..."

if pip3 install -r requirements.txt --upgrade --quiet; then
    print_success "Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯"
else
    print_warning "Ù…Ø´Ú©Ù„ Ø¯Ø± Ù†ØµØ¨ Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§ (Ù…Ù…Ú©Ù†Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ù†ØµØ¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†)"
fi

# ==============================================================================
# STEP 4: Ú†Ú© Ú©Ø±Ø¯Ù† config.py
# ==============================================================================

print_step "Ú†Ú© Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª..."

if [ ! -f "config.py" ]; then
    print_warning "ÙØ§ÛŒÙ„ config.py ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯"
    echo "Ø³Ø§Ø®Øª config.py Ø§Ø² config.example.py..."
    cp config.example.py config.py
    print_success "config.py Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯"
    print_warning "Ù„Ø·ÙØ§Ù‹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯:"
    echo "  nano config.py"
else
    print_success "config.py Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
fi

# ==============================================================================
# STEP 5: Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
# ==============================================================================

print_step "Ø³Ø§Ø®Øª Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ data Ùˆ logs..."

mkdir -p data logs
print_success "Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¢Ù…Ø§Ø¯Ù‡"

# ==============================================================================
# STEP 6: ØªØ³Øª Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
# ==============================================================================

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ§ª Ø´Ø±ÙˆØ¹ ØªØ³Øª..."
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

print_step "Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª Mihanstore scraper..."

if python3 src/platforms/mihanstore.py; then
    echo ""
    print_success "ØªØ³Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯!"
else
    echo ""
    print_error "ØªØ³Øª Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯!"
    print_warning "Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ùˆ Ú†Ú© Ú©Ù†ÛŒØ¯: logs/scraper.log"
    exit 1
fi

# ==============================================================================
# Ù¾Ø§ÛŒØ§Ù†
# ==============================================================================

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
print_success "Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…:"
echo "  python3 src/scraper.py"
echo ""
echo "Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ØªØ§ÛŒØ¬:"
echo "  cat data/products.json"
echo "  cat data/summary.json"
echo ""
echo "Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§:"
echo "  tail -f logs/scraper.log"
echo ""
